# Escape From Dungeon
- 音素材はすべて魔王魂さん( https://maou.audio )からお借りしています。

## <ゲーム説明>
- ダンジョン内を移動し、アイテムを拾ったり使ったりしながら敵を倒しゴールにたどり着いたらクリアです。
- 紫色の場所は通るとダメージを受けますが毒にはなりません。
- HPが０になるか、Limitが０になるとゲームオーバーです。HPは拾ったポーションで回復できます。
- 基本的に行き止まりには、回復イベント・アイテム・もしくは罠があります。
- 毒になる罠があり、毒状態では移動やバトルのターン中にダメージを受けます。毒消し草で解除できます。
- 毒状態は、自動では回復しません。バトル中は毒消しを持っていると自動で使います。
- 移動中はどんどん視界が狭まっていくので、拾った松明で明るくしましょう。
- 基本的に敵がドア替わりなので、敵シンボルに向かって移動すればいいでしょう。
- 途中で敵の弱点になる武器を拾えば、攻撃力がアップして楽になります。

## <操作法>
- マウスで各ボタンをクリックすることでも操作できますが、キーでの操作の方がおすすめです。

## <移動時>
- 上下左右キー：移動
- [P]キー：HP回復(ポーションの所持数があれば)
- [O]キー:毒状態回復(毒消し草の所持数があれば)
- [I]キー:明かりの範囲を広げる(松明の所持数があれば)

## <バトル中>
- 上：攻撃　敵の弱点武器を入手していた場合、攻撃力が3倍になります。
- 左：防御　防御は完全無敵ですが、バトル中でもLimitは減っていきます。
- 右：HP回復　ポーションの所持数があれば回復できます。
- 下：逃げる いつでも１００％逃げることができますが、敵をスルーは出来ません。

---
## このプログラムの制作について
- 制作期間は 8/26 ～ 9/4 の1週間ほど、さらに1週間ほど自分の中で切りの良いところまで続けました。
- マップ・敵モンスター・アイテム・イベントは CSVでデータを作成し読み込み。
- 敵モンスター・アイテム・イベントのデータは、それぞれクラスに格納しディクショナリーに追加。
- アイテムの説明については表示する予定でしたが、今回未実装。

## 表示の構造
- プレイヤーの表示はマップ中央固定(向きは四方向の画像を切り替え)、移動はマップの表示位置を変更。
- フォームアプリでは機能拡張しないと画像のアルファが親子関係にしないと有効にならない仕様のため、敵の表示はマップに直接描画。
- 敵の画像は割り切ってアルファ無しの一枚画像。

```
├─ FadeForm　タイトル・ゲームクリア時に表示するフォーム、表示の際フェード。
|   ├─ Label　タイトル・ゲームクリアの文字列表示
|   ├─ Button　スタートボタン
|   ├─ Button　終了ボタン
|
├─ Form　メインフォーム
    ├─ Image　マップ描画用の親にしてマップの表示を制御
    |   ├─ Image　マップ描画用 敵シンボルはマップに直接描画
    |       ├─ Image　照明効果をアルファで重ねて描画
    |           ├─ Image　プレイヤー表示用
    ├─ Image　敵画像表示用
    ├─ Image　プレイヤーステータス・インベントリ表示用 
    ├─ Image　タイムリミット表示用
    ├─ Image　メッセージ表示用
    ├─ Label コマンド用ラベル(↑移動 or 攻撃)
    ├─ Label コマンド用ラベル(←移動 or 防御)
    ├─ Label コマンド用ラベル(↓移動 or 逃げる)
    ├─ Label コマンド用ラベル(→移動 or 回復)
    ├─ Label アイテム使用コマンドラベル(ポーション)
    ├─ Label アイテム使用コマンドラベル(毒消し)
    ├─ Label アイテム使用コマンドラベル(松明)
```

## マップの仕様
- マップのデータは、移動判別用の配列とイベント用の配列２つに格納。イベントは通路でしか起きない仕様なので、通行判別用配列の値は通行可(0)。
- プレイヤーの移動時、移動判別用の配列で移動可能か判別し、移動が可能ならばイベント用の配列の値をチェックして処理を分岐し、イベントがある場合ディクショナリーからデータを参照。
- 移動判別用の配列は 数値に変換して格納、値1(＝壁)以外は通行可能。敵がいる場合はイベントのバトル処理優先。
- 敵のいる地点は、マップ生成時に床の上に敵シンボルの描画を重ね、敵を倒した時点で描画を床で上書きし敵シンボルを消す。

| ID | 変換値 | 説明 | 表示パーツ | 処理 |
|----|--------|------|----------|---------------|
| 00 | 0 | 通路 | 床 | 通行可 |
| 11 | 1 | 普通の壁 | 壁 | 通行不可 |
| 12 | 2 | すり抜け壁 | 壁 | 通行可、すり抜けはプレイヤー表示を消すことで表現 |
| XX | 3 | ダメージ床 | ダメージ床 | 通行可、プレイヤーダメージ処理 |
| SS | 0 | スタート地点 | 床 | 通行可、プレイヤーの初期位置を変更 |
| GG | 0 | ゴール地点 | 床 | 通行可、到達でゲームクリア |
| E? | 0 | 敵位置 | 床＋敵シンボル | 敵撃破で床を上書き描画して消す|

- 上記 E?・GG以外のIDはイベント用配列にIDを格納。イベントがない地点の値は null に。
- プレイヤー移動時に移動先地点の座標のID値をチェックし、EventType によって分岐処理。
- IDの1文字目がイベントの種類、2文字目によりメッセージ・ヒントの内容や敵の種類を変更。
- イベントはマップとは別の２次元配列にIDを格納し、ヒント表示以外のイベントは処理後に null にしイベントを削除。
- イベントは通路でしか起きない仕様なので表示パーツは床で固定。

| ID 1文字目 | ID 2文字目 | イベント内容 |
|------------|-----------|-------------|
| M | 0～3 | メッセージを表示(一度表示したらイベント削除) |
| H | 0～9、A～K | ヒントを表示(何度でも表示) |
| I | 0～8 | アイテムを入手(一度きり) |
| E | 1～9 | 敵とのバトル(逃げることが可能、倒すまでは削除されない) |
| T | 0～3 | トラップイベント(一度きり) |
| L | 0～3 | 回復イベント(一度きり) |
| G | G | ゴール地点(ゲームクリア) |

<img width="600" height="945" alt="EFD_csv" src="https://github.com/user-attachments/assets/7330e05c-c9e4-4e01-9735-e38c44c139d3" />

<img width="913" height="767" alt="EFD_map1" src="https://github.com/user-attachments/assets/2846c482-e194-4e80-91b9-ce8c629ba9e1" />

- マップのCSVは LibreOffice を使用し、マクロでセルの色を変え視覚的にわかりやすくして編集を行いました。
<img width="551" height="667" alt="EFD_map1macro" src="https://github.com/user-attachments/assets/c6a38e6e-a4c6-4f0b-ab29-7aa4d4e26549" />
